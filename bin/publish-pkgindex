#!/usr/bin/env bash
# publish-pkgindex -- Publish package index in XML and HTML
# 
# Created: 2006-04-08
# 
# Written by Jaeho Shin <netj@sparcs.org>.
# (C) 2006, Geoul Project. (http://ftp.kaist.ac.kr/geoul)
set -e
. /mirror/lib/geoul.sh
running_as_mirror_admin "$@"

# update pkgidx.xml
cd /tmp
tmp=`mktemp .geoul.index.xml.XXXXXX`
trap "rm -f $tmp" ERR HUP INT TERM

pkgs.xml -f >$tmp
chmod a+r $tmp

mv -f $tmp geoul.index.xml
ln -sf /tmp/geoul.index.xml /mirror/www/ftp.kaist.ac.kr/pkgidx.xml


# publish HTMLs
cd /mirror/www/ftp.kaist.ac.kr
set +e
for lang in ko en; do
    (
    set -e
    tmp=`mktemp /tmp/status.html.XXXXXX`
    xsltproc --param lang "'$lang'" status2html.xsl pkgidx.xml >$tmp
    chmod a+r $tmp
    mv -f $tmp .status.html.$lang
    )
done

# vim:ft=sh
