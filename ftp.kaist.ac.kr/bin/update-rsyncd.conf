#!/usr/bin/env bash
# update-rsyncd.conf -- Generate and update rsyncd.conf
# 
# Created: 2006-04-10
# 
# Written by Jaeho Shin <netj@sparcs.org>.
# (C) 2006, Geoul Project. (http://ftp.kaist.ac.kr/geoul)

. /mirror/lib/geoul.sh

{

# prologue
cat <<EOF
# WARNING: DO NOT EDIT!! Generated by update-rsyncd.conf.
uid = rsync
gid = nogroup
use chroot = no
max connections = 50
motd file = /mirror/etc/motd
log file = /var/log/geoul/rsyncd/all.log
transfer logging = yes
log format = %o %a - %u [%t] "%P/%f" - %l
pid file = /var/run/rsyncd.pid
exclude = .~tmp~

secrets file = /mirror/etc/rsyncd.secrets

EOF

# each package
mkconf() {
    ( . /mirror/lib/pkg.sh
    cat <<EOF
[$pkg]
    path = $datapath
    comment = ${source:+from $source}

[.$pkg]
    path = $datapath
    comment = private module for $pkg without connection limits for authorized mirrors
    auth users = *
    list = false
    lock file = /var/run/rsyncd-private.lock

EOF
# TODO: add size to comment
    # custom config
    if [ -r rsyncd.conf ]; then
        cat rsyncd.conf
    fi
    )
}
foreachpkg mkconf

} >/mirror/etc/rsyncd.conf
