제목: 거울의 /mirror/pkgs/에 대하여
누가: 신재호 <netj@sparcs.org>
언제: 2006년 4월 17일부터

= 개요 =
거울 시스템에서 패키지는 미러링의 서비스의 기본 단위이다.  동기화 비용, 서비스
사용량 집계, 크기 측정 등에서 자료를 묶는 단위이다.  이 문서는 이 패키지들의
정보를 담고 있는 /mirror/pkgs/의 구조에 대한 설명을 담고 있다.



= 패키지 더하고 빼기 =
/mirror/pkgs/ 아래에 패키지의 식별자(id)를 이름으로 갖는 디렉토리를 만듦으로써
패키지를 추가할 수 있다.  반대로 패키지 디렉토리를 제거함으로써 패키지를 뺄 수
있다.  이어지는 내용에서 각 패키지 디렉토리 아래에서 특별한 역할을 하거나
정보를 담고 있는 파일들에 대해서 알아보도록 한다.



= 정보표시용 파일 =
== name ==
웹페이지 등에서 표시에 사용할 이름을 담는다.
가령 /mirror/pkgs/debian/name에는 Debian을 써두면 되겠다.

== links ==
관계된 곳들의 주소를 각 줄에 하나씩 이름, URL 순으로 탭으로 구분하여 적는다.
가령,
-->8--
list	http://mirrorlist.freebsd.org/
howto	http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/cvsup.html
--8<--

== note ==
사용자들에게 보여줄 패키지 특이사항을 적는다.  UTF-8 인코딩이어야 한다.

== data ==
실제 저장할 파일의 위치를 가리키는 심볼릭 링크(symlink)여야 한다.
위치가 /mirror/ftp/ 아래인 경우 자동으로 FTP와 HTTP 링크를 만들어준다.

== original ==
다른 곳에서 동기화하는 패키지가 아닐 경우에 원본이라는 표시로 만들어준다.

== color ==
그래프 등에서 사용할 패키지의 색깔을 지정한다.
가령, 빨간색은 FF0000이라고 적어두면 된다.


= 동기화용 파일 =
== sync ==
동기화 방법을 적는다.  셸 스크립트로 실행 권한이 켜진 실행파일이다.
동기화 방법이 특이하지 않다면 보통 다음과 같은 형태를 쓰면 된다.
-->8--
#!/usr/bin/env bash
. /mirror/lib/sync.sh
get $source
--8<--
/mirror/lib/sync.sh를 읽으면 해당 패키지의 정보를 읽어와 변수들의 값을
설정한다. (가령, source는 source 파일의 내용으로).
get은 첫째 인자로 넘겨준 URL의 내용을 읽어와 data/로 복사한다.
두 번째 인자부터는 URL을 실제로 다루는 명령에게 전달해준다.

== source ==
원본 위치 URL을 담는다.
rsync에서 허용하는 host::module/path/ 형식은 쓰지 않도록 하며
rsync://host/module/path/ 와 같은 표준 형식을 쓰도록 한다.

== frequency ==
동기 주기를 적는다.
숫자만 쓰면 초를 뜻하고 이어서 단위를 붙일 수도 있다.  단위는 w는 주, d는 날,
h는 시간, '은 분, "는 초를 의미한다.  가령, 1w2d3h4'5"라면 한 주하고 이틀하고
세 시간 4분 5초라는 기간을 뜻하며, 2d30'은 48시간 30분과 같다.

== validfor ==
한 번 동기화 후 유효기간을 적는다.
패키지의 유효 상태(good,old,bad,dead 등)를 결정할 때에 사용한다.
기본은 1d이다.



= 기록용 파일 =
== timestamp ==
패키지를 성공적으로 동기화한 마지막 시각을 mtime으로 가진다.

== log.*, fail.log* ==
과거의 동기화 성공 및 실패 기록들이다.


= 임시 파일 =
동기화가 진행중이면 생기는 임시 파일들이다.

== lock ==
이 파일이 없는데 만들 수 있었던 프로세스만 동기화를 시작할 수 있다.

== lock.owner ==
동기화를 진행중인 프로세스의 PID를 담는다.

== log ==
현재 진행중인 동기화의 출력을 기록하는 파일이다.  성공 여부에 따라 log.0나
fail.log와 fail.log.0로 이름을 바꾼다.


= 통계용 파일 =
== du.rrd ==
디스크 사용량을 기록하고 있는 RRD 파일이다.


= 관리용 파일 =
== README ==
관리에 필요한 정보와 과거 기록을 담는다.

...


